<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Improv Olympics - Active Scene">
    <title>Improv Scene - Improv Olympics</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/audio-styles.css">
</head>
<body class="chat-page">
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header role="banner">
        <nav class="nav-container" role="navigation" aria-label="Main navigation">
            <div class="nav-content">
                <a href="/" class="logo-link">
                    <h1 class="logo">Improv Olympics</h1>
                </a>
                <div class="nav-actions">
                    <!-- Freemium Session Counter (IQS-65) -->
                    <div id="session-counter" class="session-counter" hidden>
                        <span class="session-icon" aria-hidden="true">üé§</span>
                        <span class="session-count">
                            <span id="sessions-used">0</span>/<span id="sessions-limit">2</span>
                        </span>
                        <button id="upgrade-btn" class="btn-upgrade" aria-label="Upgrade to premium">
                            Upgrade
                        </button>
                    </div>
                    <button id="end-session-btn" class="btn btn-danger" aria-label="End current scene">
                        End Scene
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content" role="main" class="chat-main">
        <div class="chat-container">
            <!-- Session Info Panel - Collapsible on mobile -->
            <aside class="session-info" role="complementary" aria-labelledby="session-info-title">
                <details class="session-info-details" id="session-info-details">
                    <summary class="session-info-summary">
                        <h2 id="session-info-title" class="info-title">Scene Details</h2>
                        <span class="session-info-toggle" aria-hidden="true"></span>
                    </summary>
                    <div class="session-info-body">
                        <div class="info-content">
                            <div class="info-item">
                                <span class="info-label">Game:</span>
                                <span id="session-game" class="info-value">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Turn:</span>
                                <span id="turn-counter" class="info-value">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phase:</span>
                                <span id="current-phase" class="info-value">Starting...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status:</span>
                                <span id="session-status" class="info-value status-active">Active</span>
                            </div>
                        </div>

                        <!-- Help Section -->
                        <details class="help-section">
                            <summary class="help-title">Improv Tips</summary>
                            <ul class="help-list">
                                <li>Say "Yes, and..." to build on your partner's ideas</li>
                                <li>Make specific choices and statements</li>
                                <li>Focus on your scene partner, not yourself</li>
                                <li>Listen actively and react authentically</li>
                                <li>Embrace mistakes as opportunities</li>
                            </ul>
                        </details>
                    </div>
                </details>
            </aside>

            <!-- Chat Area -->
            <section class="chat-section" aria-labelledby="chat-title">
                <h2 id="chat-title" class="sr-only">Scene Conversation</h2>

                <!-- Messages Area -->
                <div id="messages-container" class="messages-container" role="log" aria-live="polite" aria-atomic="false">
                    <div class="system-message">
                        <p class="message-text">Welcome to your improv scene! Your partner will introduce the scene. Listen carefully and build on what they say.</p>
                    </div>
                </div>

                <!-- Input Area -->
                <form id="chat-form" class="chat-input-form">
                    <div class="input-wrapper">
                        <label for="user-input" class="sr-only">Your scene line</label>
                        <textarea
                            id="user-input"
                            name="user-input"
                            class="chat-input"
                            placeholder="Type your response to the scene..."
                            rows="3"
                            maxlength="1000"
                            required
                            aria-describedby="input-help"
                        ></textarea>
                        <div class="input-meta">
                            <span id="char-count" class="char-count" aria-live="polite">0 / 1000</span>
                            <span id="input-help" class="input-help">Press Enter to send (Shift+Enter for new line)</span>
                        </div>
                    </div>
                    <button type="submit" id="send-btn" class="btn btn-primary btn-send" disabled>
                        Send
                    </button>
                </form>

                <!-- Loading State -->
                <div id="partner-typing" class="typing-indicator" role="status" aria-live="polite" style="display: none;">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-text">Your scene partner is thinking...</span>
                </div>
            </section>
        </div>
    </main>

    <!-- Error Modal -->
    <div id="error-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="error-title" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-error">
            <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
            <h2 id="error-title" class="modal-title">Something Went Wrong</h2>
            <p id="error-message" class="error-text">An unexpected error occurred.</p>
            <div class="modal-actions">
                <button id="retry-btn" class="btn btn-primary">
                    Retry
                </button>
                <button id="exit-scene-btn" class="btn btn-secondary">
                    Exit Scene
                </button>
            </div>
        </div>
    </div>

    <!-- End Session Confirmation Modal -->
    <div id="end-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="end-title" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <h2 id="end-title" class="modal-title">End This Scene?</h2>
            <p class="modal-text">
                Are you sure you want to end this scene? Your progress will be saved,
                but you won't be able to continue this specific scene.
            </p>
            <div class="modal-actions">
                <button id="cancel-end-btn" class="btn btn-secondary">
                    Continue Scene
                </button>
                <button id="confirm-end-btn" class="btn btn-danger">
                    End Scene
                </button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay" role="status" aria-live="polite">
        <div class="loading-content">
            <div class="spinner" aria-hidden="true"></div>
            <p id="loading-message" class="loading-message">Loading your scene...</p>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast-container" class="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Upgrade Modal (IQS-65) -->
    <div id="upgrade-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="upgrade-modal-title" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content upgrade-modal-content">
            <button id="close-upgrade-modal" class="modal-close" aria-label="Close">&times;</button>

            <div class="upgrade-hero">
                <div class="upgrade-icon">üé≠</div>
                <h2 id="upgrade-modal-title" class="modal-title">You've Used Your Free Audio Sessions</h2>
                <p class="upgrade-subtitle">Upgrade to Premium for unlimited voice sessions</p>
            </div>

            <div class="upgrade-comparison">
                <div class="tier-card tier-free">
                    <h3 class="tier-name">Free</h3>
                    <div class="tier-price"><span class="price-amount">$0</span>/month</div>
                    <ul class="tier-features">
                        <li class="feature-included">‚úì Unlimited text sessions</li>
                        <li class="feature-included">‚úì 2 audio sessions (lifetime)</li>
                        <li class="feature-excluded">‚úó Advanced coaching</li>
                        <li class="feature-excluded">‚úó Session history</li>
                    </ul>
                    <button class="btn btn-secondary" disabled>Current Plan</button>
                </div>

                <div class="tier-card tier-premium">
                    <div class="tier-badge">Recommended</div>
                    <h3 class="tier-name">Premium</h3>
                    <div class="tier-price"><span class="price-amount">$9.99</span>/month</div>
                    <ul class="tier-features">
                        <li class="feature-included">‚úì Everything in Free</li>
                        <li class="feature-included">‚úì <strong>Unlimited audio sessions</strong></li>
                        <li class="feature-included">‚úì Advanced coaching insights</li>
                        <li class="feature-included">‚úì Session history & playback</li>
                    </ul>
                    <button id="upgrade-to-premium-btn" class="btn btn-primary btn-large">Upgrade Now</button>
                </div>
            </div>

            <div class="upgrade-footer">
                <p>You can continue using text sessions for free.</p>
                <button id="continue-text-btn" class="btn btn-secondary">Continue with Text Mode</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v10.8.0 (compat mode for existing code) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <!-- Firebase/Identity Platform Configuration -->
    <script>
      // Identity Platform config for coherent-answer-479115-e1 project
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyCPww6j0vqFyKRez3Pr8tiVZYF6KmPkuMU",
        authDomain: "coherent-answer-479115-e1.firebaseapp.com",
        projectId: "coherent-answer-479115-e1"
      };
    </script>

    <!-- Firebase Auth Module -->
    <script type="module" src="/static/firebase-auth.js"></script>

    <!-- Mood visualization for audience reactions (IQS-56) -->
    <script src="/static/mood-visualizer.js"></script>
    <!-- Audio streaming for voice mode (IQS-62) -->
    <script src="/static/audio-codec.js"></script>
    <script src="/static/audio-manager.js"></script>
    <script src="/static/audio-ui.js"></script>
    <script src="/static/app.js"></script>
    <script>
        // Handle responsive session info panel
        function handleSessionInfoResponsive() {
            const details = document.getElementById('session-info-details');
            if (!details) return;

            const isDesktop = window.matchMedia('(min-width: 768px)').matches;

            if (isDesktop) {
                // Always open on desktop
                details.setAttribute('open', '');
            }
            // On mobile, let user control it (default closed to save space)
        }

        // Run on load and resize
        window.addEventListener('resize', handleSessionInfoResponsive);
        document.addEventListener('DOMContentLoaded', handleSessionInfoResponsive);

        // Initialize chat interface when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatInterface);
        } else {
            initializeChatInterface();
        }
    </script>
</body>
</html>
